package model

import io.circe.{Decoder, HCursor}
import org.bson.codecs.Codec
import org.mongodb.scala.MongoClient.DEFAULT_CODEC_REGISTRY
import org.mongodb.scala.bson.ObjectId
import org.mongodb.scala.bson.annotations.BsonProperty
import org.mongodb.scala.bson.codecs.Macros
import utils.UtilFunctions.md5

case class MalwareObject(
  @BsonProperty("_id") id: String,
  name: String,
  length: Int,
  prefix: Array[Byte],
  hash: String,
  offsetStart: Int,
  offsetEnd: Int
)

object MalwareObject {

  val Empty: MalwareObject = MalwareObject("", "", 0, Array.emptyByteArray, "", 0, 0)

  private lazy val codecProvider = Macros.createCodecProvider[MalwareObject]()

  implicit val bsonCodec: Codec[MalwareObject] = codecProvider.get(classOf[MalwareObject], DEFAULT_CODEC_REGISTRY)

  implicit val decoder: Decoder[MalwareObject] = (c: HCursor) => {
    for {
      id <- c.downField("_id").as[String]
      name <- c.downField("name").as[String]
      length <- c.downField("length").as[Int]
      prefix <- c.downField("prefix").as[Array[Byte]]
      hash <- c.downField("hash").as[String]
      offsetStart <- c.downField("offsetStart").as[Int]
      offsetEnd <- c.downField("offsetEnd").as[Int]
    } yield {
      new MalwareObject(id, name, length, prefix, hash, offsetStart, offsetEnd)
    }
  }

  //TODO: Удалить после дебагов
  def apply(name: String, signature: Array[Byte], offsetStart: Int, offsetEnd: Int): MalwareObject =
    MalwareObject(
      new ObjectId().toHexString,
      name,
      signature.length,
      signature.take(7),
      md5(signature),
      offsetStart,
      offsetEnd
    )

}
